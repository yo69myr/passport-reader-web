<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passport Reader</title>
    <link href="./static/output_ost.css" rel="stylesheet">
</head>
<body class="font-sans min-h-screen bg-gradient-to-b from-blue-100 to-pink-100 flex items-center justify-center">
    <div id="main-menu" class="bg-white p-10 rounded-3xl shadow-xl max-w-lg w-full text-center">
        <h1 class="text-5xl font-bold text-blue-800 mb-8">Passport Reader</h1>
        <button onclick="showRegister()" class="bg-blue-300 text-blue-800 font-medium py-4 px-4 rounded-xl w-80 hover:bg-blue-400 hover:scale-105 transition duration-300">Реєстрація</button>
        <button onclick="showLogin()" class="bg-pink-300 text-pink-800 font-medium py-4 px-4 rounded-xl w-80 mt-6 hover:bg-pink-400 hover:scale-105 transition duration-300">Вхід</button>
    </div>

    <div id="register-form" class="hidden bg-white p-10 rounded-3xl shadow-xl max-w-lg w-full text-center">
        <h2 class="text-4xl font-bold text-blue-800 mb-8">Реєстрація</h2>
        <form onsubmit="registerUser(event)">
            <div class="space-y-6">
                <input type="text" id="reg-login" placeholder="Логін" class="w-full p-4 border border-blue-300 rounded-xl focus:ring-2 focus:ring-blue-300 text-lg">
                <input type="password" id="reg-password" placeholder="Пароль" class="w-full p-4 border border-blue-300 rounded-xl focus:ring-2 focus:ring-blue-300 text-lg">
            </div>
            <button type="submit" class="bg-blue-300 text-blue-800 font-medium py-4 px-4 rounded-xl w-full mt-8 hover:bg-blue-400 hover:scale-105 transition duration-300">Зареєструватися</button>
        </form>
        <button onclick="showMainMenu()" class="text-blue-600 mt-2">Повернутися на початкову сторінку</button>
    </div>

    <div id="login-form" class="hidden bg-white p-10 rounded-3xl shadow-xl max-w-lg w-full text-center">
        <h2 class="text-4xl font-bold text-pink-800 mb-8">Вхід</h2>
        <form onsubmit="loginUser(event)">
            <div class="space-y-6">
                <input type="text" id="login-login" placeholder="Логін" class="w-full p-4 border border-pink-300 rounded-xl focus:ring-2 focus:ring-blue-300 text-lg">
                <input type="password" id="login-password" placeholder="Пароль" class="w-full p-4 border border-pink-300 rounded-xl focus:ring-2 focus:ring-blue-300 text-lg">
            </div>
            <button type="submit" class="bg-pink-300 text-pink-800 font-medium py-4 px-4 rounded-xl w-full mt-8 hover:bg-pink-400 hover:scale-105 transition duration-300">Увійти</button>
        </form>
        <button onclick="showMainMenu()" class="text-blue-600 mt-2">Повернутися на початкову сторінку</button>
    </div>

    <div id="account-info" class="hidden bg-white p-10 rounded-3xl shadow-xl max-w-lg w-full text-center">
        <h2 class="text-4xl font-bold text-blue-800 mb-8">Акаунт</h2>
        <p class="text-xl text-gray-700">Логін: <span id="account-login"></span></p>
        <p class="text-xl text-gray-700 mt-2">Дата створення: <span id="account-created"></span></p>
        <p class="text-xl text-gray-700 mt-2">Підписка: <span id="account-subscription"></span></p>
        <button onclick="logoutUser()" class="bg-red-300 text-red-800 font-medium py-4 px-4 rounded-xl w-full mt-8 hover:bg-red-400 hover:scale-105 transition duration-300">Вийти</button>
    </div>

    <div id="admin-panel" class="hidden bg-white p-8 rounded-3xl shadow-xl max-w-5xl w-full overflow-x-auto">
        <h2 class="text-4xl font-bold text-blue-800 mb-8 text-center">Адміністративна панель</h2>
        <table class="w-full border-collapse border border-gray-300">
            <thead>
                <tr>
                    <th class="border border-gray-300 p-2">№</th>
                    <th class="border border-gray-300 p-2">Логін</th>
                    <th class="border border-gray-300 p-2">Дата створення</th>
                    <th class="border border-gray-300 p-2">Пароль (хеш)</th>
                    <th class="border border-gray-300 p-2">Підписка активна</th>
                    <th class="border border-gray-300 p-2">Дата закінчення</th>
                    <th class="border border-gray-300 p-2">Сесія активна</th>
                    <th class="border border-gray-300 p-2">Дія</th>
                </tr>
            </thead>
            <tbody id="users-table">
            </tbody>
        </table>
        <button onclick="endAllSessions()" class="bg-red-300 text-red-800 font-medium py-3 px-4 rounded-xl mt-6 hover:bg-red-400 hover:scale-105 transition duration-300">Завершити всі сесії</button>
        <button onclick="logoutUser()" class="bg-red-300 text-red-800 font-medium py-3 px-4 rounded-xl mt-6 ml-4 hover:bg-red-400 hover:scale-105 transition duration-300">Вийти</button>
    </div>

    <div id="success-message" class="hidden bg-white p-10 rounded-3xl shadow-xl max-w-md w-full text-center">
        <h2 class="text-4xl font-bold text-green-800 mb-8">Акаунт успішно створено</h2>
        <button onclick="showLogin()" class="bg-green-300 text-green-800 font-medium py-4 px-4 rounded-xl w-full hover:bg-green-400 hover:scale-105 transition duration-300">Перейти до входу</button>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-lg max-w-md w-full text-center">
            <p id="modal-message" class="text-xl text-gray-700 mb-6"></p>
            <button onclick="closeModal()" class="bg-blue-300 text-blue-800 font-medium py-3 px-4 rounded-xl hover:bg-blue-400">OK</button>
        </div>
    </div>

    <script>
        let currentUser = null;
        let adminCredentials = { login: 'yokoko', password: 'anonanonNbHq1554o' };

        function showMainMenu() {
            hideAll();
            document.getElementById('main-menu').classList.remove('hidden');
        }

        function showRegister() {
            hideAll();
            document.getElementById('register-form').classList.remove('hidden');
        }

        function showLogin() {
            hideAll();
            document.getElementById('login-form').classList.remove('hidden');
        }

        function showAccount(user) {
            hideAll();
            document.getElementById('account-info').classList.remove('hidden');
            document.getElementById('account-login').textContent = user.login;
            document.getElementById('account-created').textContent = user.created_at;
            document.getElementById('account-subscription').textContent = user.subscription_active ? 'Активна' : 'Неактивна';
            if (user.is_admin) {
                showAdminPanel();
            }
        }

        function showAdminPanel() {
            hideAll();
            document.getElementById('admin-panel').classList.remove('hidden');
            fetchUsers();
        }

        function showSuccess() {
            hideAll();
            document.getElementById('success-message').classList.remove('hidden');
        }

        function hideAll() {
            const sections = ['main-menu', 'register-form', 'login-form', 'account-info', 'admin-panel', 'success-message'];
            sections.forEach(id => document.getElementById(id).classList.add('hidden'));
        }

        function showModal(message) {
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        async function registerUser(event) {
            event.preventDefault();
            const login = document.getElementById('reg-login').value;
            const password = document.getElementById('reg-password').value;

            const response = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ login, password })
            });
            const data = await response.json();

            if (data.status === 'success') {
                showSuccess();
            } else {
                showModal(data.message);
            }
        }

        async function loginUser(event) {
            event.preventDefault();
            const login = document.getElementById('login-login').value;
            const password = document.getElementById('login-password').value;

            const response = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ login, password })
            });
            const data = await response.json();

            if (data.status === 'success') {
                currentUser = { login, password };
                showAccount(data);
            } else {
                showModal(data.message);
            }
        }

        async function logoutUser() {
            if (!currentUser) return;

            const response = await fetch('/api/logout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ login: currentUser.login })
            });
            const data = await response.json();

            if (data.status === 'success') {
                currentUser = null;
                showMainMenu();
            } else {
                showModal(data.message);
            }
        }

        async function fetchUsers() {
            const response = await fetch('/api/admin/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(adminCredentials)
            });
            const data = await response.json();

            if (data.status === 'success') {
                const tableBody = document.getElementById('users-table');
                tableBody.innerHTML = '';
                data.users.forEach((user, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="border border-gray-300 p-2">${index + 1}</td>
                        <td class="border border-gray-300 p-2">${user.login}</td>
                        <td class="border border-gray-300 p-2">${user.created_at}</td>
                        <td class="border border-gray-300 p-2 break-all">${user.password_hash}</td>
                        <td class="border border-gray-300 p-2">${user.subscription_active ? 'Так' : 'Ні'}</td>
                        <td class="border border-gray-300 p-2">${user.subscription_expiry || 'N/A'}</td>
                        <td class="border border-gray-300 p-2">${user.session_active ? 'Так' : 'Ні'}</td>
                        <td class="border border-gray-300 p-2">
                            <select id="duration-${user.login}" class="p-2 border rounded">
                                <option value="deactivate">Деактивувати</option>
                                <option value="1 hour">1 година</option>
                                <option value="3 hours">3 години</option>
                                <option value="6 hours">6 годин</option>
                                <option value="12 hours">12 годин</option>
                                <option value="24 hours">24 години</option>
                                <option value="3 days">3 дні</option>
                                <option value="15 days">15 днів</option>
                                <option value="30 days">30 днів</option>
                                <option value="60 days">60 днів</option>
                                <option value="90 days">90 днів</option>
                                <option value="120 days">120 днів</option>
                                <option value="150 days">150 днів</option>
                            </select>
                            <button onclick="updateSubscription('${user.login}')" class="bg-blue-200 text-blue-600 py-1 px-2 rounded ml-2 hover:bg-blue-300">Оновити</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                showModal(data.message);
            }
        }

        async function updateSubscription(userLogin) {
            const durationSelect = document.getElementById(`duration-${userLogin}`);
            const duration = durationSelect.value;

            const response = await fetch('/api/admin/update_subscription', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...adminCredentials, user_login: userLogin, duration })
            });
            const data = await response.json();

            if (data.status === 'success') {
                fetchUsers(); // Оновити таблицю
            } else {
                showModal(data.message);
            }
        }

        async function endAllSessions() {
            // Логіка для завершення всіх сесій (якщо потрібно, додайте ендпоінт на бекенді)
            showModal('Всі сесії завершено (реалізуйте на бекенді якщо потрібно).');
        }
    </script>
</body>
</html>
